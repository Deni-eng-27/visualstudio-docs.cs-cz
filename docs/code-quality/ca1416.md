---
title: 'ca1416: ověření kompatibility platformy'
ms.date: 09/01/2020
ms.topic: reference
f1_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
helpviewer_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
author: buyaa-n
ms.author: bunamnan
manager: jeffhandley
ms.workload:
- multiple
ms.openlocfilehash: a8185cc625898acd81628f100b6b0bd7d98be417
ms.sourcegitcommit: a18c7e9b367c2f92f6e54c3eaef442775d457667
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 09/15/2020
ms.locfileid: "90108626"
---
# <a name="ca1416-validate-platform-compatibility"></a>CA1416: ověření kompatibility platformy

|||
|-|-|
|CheckId|CA1416|
|Kategorie|Microsoft. interoperabilita|
|Zásadní změna|Nenarušující|

## <a name="cause"></a>Příčina

Porušení jsou hlášena pro použití rozhraní API závislého na platformě v jednom z následujících kontextů
- Rozhraní API specifické pro platformu: 
  - Kontext neutrální pro platformu.
  - Jiný kontext platformy.
- Rozhraní API není pro aktuální cílovou platformu podporováno.

Toto pravidlo je ve výchozím nastavení povoleno pouze u projektů cílících na `net5.0` nebo později. Můžete ji ale [Povolit](#configurability) pro projekty, které cílí na jiné architektury.

## <a name="rule-description"></a>Popis pravidla

V .NET 5,0 jsme přidali nové atributy pro anotaci rozhraní API specifických pro konkrétní platformu. To funguje takto:
- Neoznačené rozhraní API se považuje za fungovat na všech platformách operačního systému.
- Rozhraní API označené jako `[SupportedOSPlatform("platformName")]` je považováno za přenosné pouze na zadané platformy operačního systému (atribut lze použít několikrát s různými platformami).
- Rozhraní API označené se `[UnsupportedOSPlatform("platformName")]` považuje za nepodporované jenom na zadané platformy operačního systému (atribut se dá použít víckrát s různými platformami).
- U obou atributů lze vytvořit instanci s čísly verze nebo bez nich jako součást názvu platformy.
- Pokud `[SupportedOSPlatform] and [UnsupportedOSPlatform]` je k dispozici kombinace atributů, seskupte všechny atributy podle identifikátoru platformy operačního systému:
  - **Seznam povolených**. Pokud je nejnižší verze pro každou platformu operačního systému `[SupportedOSPlatform]` atribut, rozhraní API se považuje za podporované jenom v uvedených platformách a nepodporované na všech ostatních platformách. Seznam může mít `[UnsupportedOSPlatform]` atribut se stejnou platformou, ale jenom s vyšší verzí, což značí, že rozhraní API se z této verze odebere.
  - **Seznam odepřených**. Pokud je nejnižší verze pro každou platformu operačního systému `[UnsupportedOSPlatform]` atribut, pak rozhraní API je považováno za nepodporované v uvedených platformách a podporované všemi ostatními platformami. Seznam může mít `[SupportedOSPlatform]` atribut se stejnou platformou, ale jenom s vyšší verzí, což značí, že rozhraní API je přidané z této verze.
  - **Nekonzistentní seznam**. Pokud je nejnižší verze u některých platforem v `[SupportedOSPlatform]` době, kdy je `[UnsupportedOSPlatform]` pro jiné platformy, považuje se za nekonzistentní a poznámky na rozhraní API se ignorují. Plánujeme zavést další analyzátor, který vyprodukuje upozornění v případě nekonzistence v budoucnosti.

Přístup k rozhraním API v poznámce s výše uvedenými atributy z různých kontextů platforem může způsobit následující porušení.

### <a name="violations"></a>Porušení
- Přístup k rozhraní API, které je podporované jenom na zadané platformě ( `[SupportedOSPlatform("platformName")]` ) z kódu dostupného na jiných platformách, bude mít za následek porušení těchto údajů: `'API' is supported on 'platformName'.`

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }

  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  ```

  > [!NOTE]
  > K porušení dojde pouze v případě, že projekt není cílen na podporovanou platformu ( `net5.0-differentPlatform` ). To platí také pro cílené projekty ( `net5.0` ). Pokud je projekt cílen na určenou platformu (), neproběhne žádné porušení `net5.0-platformName` .

- Přístup k rozhraní API s atributem `[UnsupportedOSPlatform("platformName")]` z kontextu, který cílí na platformu, `platformName` může způsobit narušení: `'API' is unsupported on 'platformName'.`

  ```csharp
  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")] 
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }
  ```

  > [!NOTE]
  > Pokud vytváříte aplikaci, která necílí na nepodporovanou platformu, nebudete mít žádné porušení. K porušení dochází pouze v následujících případech:
  > - Pokud projekt cílí na atribut platformy, který není podporován nebo
  > - `platformName`Je součástí `MSBuild` `<SupportedPlatform>` skupiny výchozích položek nebo
  > - Ručně včetně `platformName` ve `<SupportedPlatform>` skupině položek MSBuild:

  ```XML
  <ItemGroup>
      <SupportedPlatform Include="platformName" />
  </ItemGroup>
  ```

## <a name="how-to-fix-violations"></a>Jak opravit porušení

Doporučeným způsobem, jak řešit tato porušení, je zajistit, abyste při spuštění na příslušných platformách zavolali pouze tato rozhraní API. Toho lze dosáhnout vyloučením kódu v době sestavení pomocí #if a cílení na více platforem nebo pomocí podmíněného volání kódu za běhu. Analyzátor rozpozná nové ochranné sady pro platformy, které jsme přidali do <xref:System.OperatingSystem> společně s tradičním <xref:System.Runtime.InteropServices.RuntimeInformation.IsOSPlatform%2A?displayProperty=fullName> , který můžete použít ke kontrole. 

- Potlačit porušení tím, že okolní web volá metody ochrany Platform Guard

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }  

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  
                                              
  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  // The diagnostics fixed using platform guard methods
  public void Caller()
  {
      if (OperatingSystem.IsLinux())
      {
          LinuxOnlyApi(); // no diagnostic
      }

      if (OperatingSystem.IsIOSVersionAtLeast(14))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }

      if(RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }
  }

  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")]  
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }

  public void Caller()
  {
      if (!OperatingSystem.IsAndroid())
      {
          DoesNotWorkOnAndroid(); // no diagnostic
      }

      // Can use &&, || logical operators to guard combined attributes
      if (!OperatingSystem.IsWindows() || OperatingSystem.IsWindowsVersionAtLeast(10, 0, 1903))
      {
          StartedWindowsSupportFromCertainVersion(); // no diagnostic
      }
  }

  ```

- Analyzátor taky dodržuje <xref:System.Diagnostics.Debug.Assert%2A?displayProperty=fullName> jako způsob, jak zabránit tomu, aby byl kód dostupný na nepodporovaných platformách. Pomocí `Debug.Assert` této možnost můžete v případě potřeby tuto kontrolu vystříhat z buildů vydaných verzí.

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { } 

  public void Caller() 
  {
      Debug.Assert(OperatingSystem.IsLinux());

      LinuxOnlyApi(); // No diagnostic
  } 
  ```

- Vlastní rozhraní API můžete označit jako specifické pro platformu a efektivně tak jednoduše předávat požadavky volajícím. Můžete použít atributy platformy na některou z následujících možností:
  - Typy
  - Členové (metody, pole, vlastnosti a události)
  - Sestavení

  ```csharp
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  

  [SupportedOSPlatform("ios15.0")] // call site version should be equal to or higher than the API version
  public void Caller() 
  { 
      SupportedOnWindowsAndIos14(); // No diagnostics
  } 

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void Caller() 
  { 
      StartedWindowsSupportFromCertainVersion(); // No diagnostics
  } 
  ```

- Při použití atributu sestavení nebo na úrovni typu se všechny členy v sestavení nebo typu považují za specifické pro platformu.

  ```csharp
  [assembly:SupportedOSPlatform("windows")]
  public namespace ns
  {
      public class Sample
      {
          public void SupportedOnWindows() { }  
      
          public void Caller() 
          { 
              SupportedOnWindows(); // No diagnostic as call site and calling method both windows only
          }
      }
  } 
  ```

## <a name="when-to-suppress-warnings"></a>Kdy potlačit upozornění

Odkazování na rozhraní API specifická pro platformu bez správného kontextu platformy/ochrany se nedoporučuje. V případě potřeby však můžete tuto diagnostiku potlačit běžným způsobem ( `<NoWarn>` , konfigurací editoru nebo #pragma):

```csharp
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Caller() 
{ 
#pragma warning disable CA1416
    LinuxOnlyApi(); 
#pragma warning restore CA1416
} 
```

## <a name="configurability"></a>Konfigurovatelnost

Analyzátor je ve výchozím nastavení povolen pouze pro projekty cílené na `net5.0` nebo vyšší a má [AnalysisLevel](https://docs.microsoft.com/dotnet/core/project-sdk/msbuild-props#analysislevel) 5 (výchozí nastavení pro `net5.0` projekty). Můžete ji povolit pro cílové rozhraní nižší než `net5.0` , přidáním následující dvojice klíč-hodnota do souboru. editorconfig v projektu:

```ini
dotnet_code_quality.enable_platform_analyzer_on_pre_net5_target=true
```

Další informace najdete v tématu [Konfigurace analyzátorů kvality kódu .NET](configure-fxcop-analyzers.md).

## <a name="see-also"></a>Viz také

- [Zadávání poznámek k rozhraním API specifických pro konkrétní platformu a zjištění jejich použití](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-checks/platform-checks.md)
- [Zadávání poznámek na rozhraních API na konkrétních platformách jako nepodporované](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-exclusion/platform-exclusion.md)
- [Názvy cílových rozhraní v rozhraní .NET 5](https://github.com/dotnet/designs/blob/master/accepted/2020/net5/net5.md)
- [Analyzátor rozhraní .NET API](https://docs.microsoft.com/dotnet/standard/analyzers/api-analyzer)
- [Upozornění interoperability](/dotnet/framework/interop/index)